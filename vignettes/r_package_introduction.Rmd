---
title: "R Package Introduction"
subtitle: "dmdScheme Version v`r read.dcf(here::here('DESCRIPTION'), all = TRUE)[['Version']]`"
author: "Rainer M Krug <Rainer@uzh.ch>"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{R Package Introduction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
  collapse = TRUE,
  comment = "#>"
)
library(dmdScheme)
library(here)
# library(magrittr)
# library(dplyr)
# library(knitr)
library(kableExtra)
# library(plantuml)
#
v <- read.dcf(here::here('DESCRIPTION'), all = TRUE)[['Version']]
```

# The R Package

The package `dmdScheme` is a base package to define domain specific metadata schemes, enter the metadata, validate the entered metadata, and export it to xml format for further processing by e.g. archival repositories. This vignette will give an overview over the `dmdScheme` package and what it contains. More detailed information about the development, including a suggested workflow, can be found in the vignette **Howto create a new scheme**. The usage of a derived scheme is explained in the package `emeScheme` in the vignette **User Manual**.

## Installation

**OP: Make sure this section is consistent with the corresponding on in  howto_create_new_scheme.rmd

The package is not yet on CRAN. Therefore it needs to be installed from github. This will install the last verion on github.

For a list of releases see [here](https://github.com/rkrug/dmdScheme/releases)

```{r echo=TRUE, eval = FALSE}
## install the devtools package if not installed yet
# install.packages("devtools")

## install the last stable version of dmdScheme from github
devtools::install_github("Exp-Micro-Ecol-Hub/dmdScheme", build_opts = c("--no-resave-data"))

## install a specific release, e.g. v0.8, of dmdScheme from github
devtools::install_github("Exp-Micro-Ecol-Hub/dmdScheme", ref = "dev", build_opts = c("--no-resave-data"))
```


## Entering new Metadata

To enter new data to the dmdScheme, you have to

```{r echo=TRUE, eval = FALSE}
library("dmdScheme")
open_new_spreadsheet("dmdScheme")
```

This will open Excel and the file should look similar to this, when looking at the second tab:

<!-- ![](./figs/enter_new_data.png) -->

The following points are important to remember:

1) The file is saved in a **temporary** directory. It needs to be saved at a different location, if you want to keep the changes.
2) Data can only be entered in the green cells with. All other cells are write protected.

After entering the data, save it to a location for further processing.


## Validating your metadata

The metadata in the spreadsheet can be validated by using

```{r validate, echo = TRUE, eval = TRUE}
val <- validate( system.file("installedSchemes", paste0(scheme_default()$name, "_", scheme_default()$version, ".xlsx"), package = "dmdScheme") )
```

which results in an object of class `dmdScheme_validation`.

To create a report (html, pdf or docx) yo can use the `report()` function:

```{r report, echo = TRUE, eval = FALSE}
report(val)
```

which will open a html report in your browser.

## Converting Metadata to xml

You can export the data to an an xml file:

```{r example_export_xml, echo=TRUE, eval = TRUE}
x <- read_excel( system.file("installedSchemes", paste0(scheme_default()$name, "_", scheme_default()$version, ".xlsx"), package = "dmdScheme") )
as_xml( x )
```

When you specify the argument `file`, the xml will be saved:

```{r example_export_xml_file, echo=TRUE, eval = TRUE}
xmlFile = tempfile(fileext = ".xml")
x <- read_excel( system.file("installedSchemes", paste0(scheme_default()$name, "_", scheme_default()$version, ".xlsx"), package = "dmdScheme") )
write_xml( x = x, file = xmlFile )
```

## Re-import from xml into R

```{r example_import_xml, eval = TRUE}
x <- read_xml( xmlFile )
x
```

## Importing Data from Excel Sheet

Next, you have to import the data entered in the Excel sheet into R. For simplicity, we use here a file included in the package. If you want to load your own file, replace `system.file("dmdScheme.xlsx", package = "dmdScheme")` with the file name and path to that file.

```{r echo = TRUE, eval = TRUE}
x <- read_excel(
      file = system.file("installedSchemes", paste0(scheme_default()$name, "_", scheme_default()$version, ".xlsx"), package = "dmdScheme"),
      verbose = TRUE
)
```

The `verbose = TRUE` argument will produce messages which will show you what is happening and will help to identify problems.

## Print dmdScheme Data

`dmdScheme` Data can be printed by using the `print()` function. The function has three arguments which control the printout:

* `printAttr`: if `TRUE` (default) print the **basic** attributes prefixed with `A   `
* `printExAttr`: if `TRUE` print the **all** attributes prefixed with `X   `
* `printData`: if `TRUE` (default) print the data prefixed with `D   `

```{r, echo = TRUE}
print(
  x,
  printAttr = FALSE,
  printExtAttr = FALSE,
  printData = FALSE
)
```

```{r, echo = TRUE}
print(
  x,
  printAttr = TRUE,
  printExtAttr = FALSE,
  printData = FALSE
)
```

```{r, echo = TRUE}
print(
  x,
  printAttr = TRUE,
  printExtAttr = TRUE,
  printData = FALSE
)
```

```{r, echo = TRUE}
print(
  x,
  printAttr = TRUE,
  printExtAttr = TRUE,
  printData = TRUE
)
```


## General things

The `dmdScheme` data in R can be also saved, loaded, and edited using the standard R commands.
